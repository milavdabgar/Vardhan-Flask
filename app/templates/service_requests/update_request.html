{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Update Request #{{ request.ticket_number }}</h1>
        <a href="{{ url_for('service_requests.list_requests') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Requests
        </a>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Edit Request Details</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" id="action" value="">
                        
                        {% for action_id, action_label, action_color in request.get_allowed_actions(current_user) %}
                            {% if action_id == 'edit' %}
                                {# College Admin - Edit Request Form #}
                                <!-- Progress Indicator -->
                                <div class="progress mb-4" style="height: 2px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>

                                <div class="mb-4">
                                    <h5 class="text-primary mb-3">Basic Information</h5>
                                    <div class="mb-3">
                                        <label for="title" class="form-label">Title <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="A clear, concise summary of the issue"></i></label>
                                        <input type="text" class="form-control" id="title" name="title" 
                                               value="{{ request.title }}" required
                                               placeholder="e.g., 'Printer not responding' or 'No internet in Lab 201'">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="Include any relevant details that could help diagnose the issue"></i></label>
                                        <textarea class="form-control" id="description" name="description" 
                                                  rows="4" required placeholder="Please include:
- What is not working
- When did it start
- What have you tried so far
- Any error messages you see">{{ request.description }}</textarea>
                                    </div>
                                </div>
                                    
                                    <!-- Problem Category Selection -->
                                    <div class="mb-4">
                                        <h5 class="text-primary mb-3">Issue Classification</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="problem_category" class="form-label">Problem Category <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="Select the most appropriate category for your issue"></i></label>
                                                <select class="form-select" id="problem_category" name="problem_category" required>
                                                    <option value="">Select category</option>
                                                    <option value="single_equipment" data-icon="fas fa-desktop" {% if request.problem_category == 'single_equipment' %}selected{% endif %}>Single Equipment Issue</option>
                                                    <option value="network" data-icon="fas fa-network-wired" {% if request.problem_category == 'network' %}selected{% endif %}>Network Connectivity</option>
                                                    <option value="wifi" data-icon="fas fa-wifi" {% if request.problem_category == 'wifi' %}selected{% endif %}>WiFi Coverage</option>
                                                    <option value="cctv" data-icon="fas fa-video" {% if request.problem_category == 'cctv' %}selected{% endif %}>CCTV System</option>
                                                    <option value="infrastructure" data-icon="fas fa-building" {% if request.problem_category == 'infrastructure' %}selected{% endif %}>Infrastructure</option>
                                                </select>
                                            </div>
                                        
                                            <div class="col-md-6">
                                                <label for="priority" class="form-label">Priority <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="Select based on impact and urgency"></i></label>
                                                <select class="form-select" id="priority" name="priority" required>
                                                    <option value="">Select priority</option>
                                                    <option value="low" data-badge="success" {% if request.priority == 'low' %}selected{% endif %}>Low - No immediate impact</option>
                                                    <option value="medium" data-badge="warning" {% if request.priority == 'medium' %}selected{% endif %}>Medium - Limited impact</option>
                                                    <option value="high" data-badge="danger" {% if request.priority == 'high' %}selected{% endif %}>High - Significant impact</option>
                                                    <option value="urgent" data-badge="dark" {% if request.priority == 'urgent' %}selected{% endif %}>Urgent - Critical impact</option>
                                                </select>
                                                <small class="form-text text-muted mt-1" id="priority-help"></small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Single Equipment Fields -->
                                    <div id="single_equipment_fields" class="d-none">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="contract_id" class="form-label">AMC Contract</label>
                                                <select class="form-select" id="contract_id" name="contract_id">
                                                    <option value="">Select contract</option>
                                                    {% for contract in contracts %}
                                                    <option value="{{ contract.id }}" {% if request.contract_id == contract.id %}selected{% endif %}>
                                                        {{ contract.contract_number }} ({{ contract.contract_type }})
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="equipment_id" class="form-label">Equipment</label>
                                                <select class="form-select" id="equipment_id" name="equipment_id">
                                                    <option value="">Select equipment</option>
                                                    {% if request.equipment %}
                                                    <option value="{{ request.equipment.id }}" selected>
                                                        {{ request.equipment.name }} ({{ request.equipment.type }})
                                                    </option>
                                                    {% endif %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Network/WiFi Fields -->
                                    <div id="network_fields" class="d-none">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="issue_type" class="form-label">Issue Type</label>
                                                <select class="form-select" id="issue_type" name="issue_type">
                                                    <option value="">Select issue type</option>
                                                    <!-- Network Issues -->
                                                    <optgroup label="Network Issues" class="network-issues">
                                                        <option value="no_internet" {% if request.issue_type == 'no_internet' %}selected{% endif %}>No Internet Connection</option>
                                                        <option value="slow_speed" {% if request.issue_type == 'slow_speed' %}selected{% endif %}>Slow Network Speed</option>
                                                        <option value="intermittent" {% if request.issue_type == 'intermittent' %}selected{% endif %}>Intermittent Connection</option>
                                                        <option value="dns_issue" {% if request.issue_type == 'dns_issue' %}selected{% endif %}>DNS Resolution Problem</option>
                                                    </optgroup>
                                                    <!-- WiFi Issues -->
                                                    <optgroup label="WiFi Issues" class="wifi-issues">
                                                        <option value="no_wifi" {% if request.issue_type == 'no_wifi' %}selected{% endif %}>No WiFi Signal</option>
                                                        <option value="weak_signal" {% if request.issue_type == 'weak_signal' %}selected{% endif %}>Weak WiFi Signal</option>
                                                        <option value="authentication" {% if request.issue_type == 'authentication' %}selected{% endif %}>WiFi Authentication Error</option>
                                                        <option value="frequent_disconnect" {% if request.issue_type == 'frequent_disconnect' %}selected{% endif %}>Frequent Disconnection</option>
                                                    </optgroup>
                                                    <!-- CCTV Issues -->
                                                    <optgroup label="CCTV Issues" class="cctv-issues">
                                                        <option value="no_feed" {% if request.issue_type == 'no_feed' %}selected{% endif %}>No Camera Feed</option>
                                                        <option value="poor_quality" {% if request.issue_type == 'poor_quality' %}selected{% endif %}>Poor Video Quality</option>
                                                        <option value="recording_issue" {% if request.issue_type == 'recording_issue' %}selected{% endif %}>Recording Not Working</option>
                                                        <option value="playback_issue" {% if request.issue_type == 'playback_issue' %}selected{% endif %}>Playback Problems</option>
                                                    </optgroup>
                                                    <!-- Infrastructure Issues -->
                                                    <optgroup label="Infrastructure Issues" class="infrastructure-issues">
                                                        <option value="cable_damage" {% if request.issue_type == 'cable_damage' %}selected{% endif %}>Cable/Wire Damage</option>
                                                        <option value="port_issue" {% if request.issue_type == 'port_issue' %}selected{% endif %}>Network Port Problem</option>
                                                        <option value="ups_issue" {% if request.issue_type == 'ups_issue' %}selected{% endif %}>UPS/Power Issue</option>
                                                        <option value="rack_issue" {% if request.issue_type == 'rack_issue' %}selected{% endif %}>Network Rack Problem</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="affected_users" class="form-label">Affected Users</label>
                                                <input type="number" class="form-control" id="affected_users" name="affected_users"
                                                       value="{{ request.affected_users }}" placeholder="Number of users affected">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Location Fields -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="building" class="form-label">Building</label>
                                            <input type="text" class="form-control" id="building" name="building"
                                                   value="{{ request.building }}" placeholder="Building name/number">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="floor" class="form-label">Floor</label>
                                            <input type="text" class="form-control" id="floor" name="floor"
                                                   value="{{ request.floor }}" placeholder="Floor number">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="room" class="form-label">Room/Lab</label>
                                            <input type="text" class="form-control" id="room" name="room"
                                                   value="{{ request.room }}" placeholder="Room/Lab number">
                                        </div>
                                    </div>
                                    
                                    <!-- Additional Details -->
                                    <div class="mb-3">
                                        <label for="area_details" class="form-label">Additional Location Details</label>
                                        <textarea class="form-control" id="area_details" name="area_details" rows="2"
                                                  placeholder="Any additional details about the location">{{ request.area_details }}</textarea>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-{{ action_color }}" 
                                        onclick="document.getElementById('action').value='{{ action_id }}'">
                                    {{ action_label }}
                                </button>
                            {% elif action_id in ['schedule', 'reschedule'] %}
                                {# Junior Technician - Schedule Visit Form #}
                                <div class="mb-3">
                                    <h5>Schedule Visit</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="scheduled_date" class="form-label">Date</label>
                                            <input type="date" class="form-control" id="scheduled_date" 
                                                   name="scheduled_date" required min="{{ now.strftime('%Y-%m-%d') }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="scheduled_time" class="form-label">Time</label>
                                            <input type="time" class="form-control" id="scheduled_time" 
                                                   name="scheduled_time" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="comment" class="form-label">Add Comment</label>
                                    <textarea class="form-control" id="comment" name="comment" rows="3" 
                                              placeholder="Add details about the scheduled visit"></textarea>
                                </div>
                                <button type="submit" class="btn btn-{{ action_color }}" 
                                        onclick="document.getElementById('action').value='{{ action_id }}'">
                                    {{ action_label }}
                                </button>
                            {% elif action_id == 'mark_visited' %}
                                {# College Admin - Mark Visit Form #}
                                <div class="mb-3">
                                    <h5>Confirm Technician Visit</h5>
                                    <p class="text-muted">Scheduled for: {{ request.format_schedule_time() }}</p>
                                    <div class="mb-3">
                                        <label for="comment" class="form-label">Visit Notes</label>
                                        <textarea class="form-control" id="comment" name="comment" rows="3" required
                                                  placeholder="Please provide details about the technician's visit and work done"></textarea>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-{{ action_color }}" 
                                        onclick="document.getElementById('action').value='{{ action_id }}'">
                                    {{ action_label }}
                                </button>
                            {% else %}
                                {% if action_id in ['hold', 'close', 'reopen'] %}
                                    <button type="button" class="btn btn-{{ action_color }} mb-3" 
                                            data-bs-toggle="modal" data-bs-target="#{{ action_id }}Modal">
                                        {{ action_label }}
                                    </button>
                                {% else %}
                                    <button type="submit" class="btn btn-{{ action_color }} mb-3" 
                                            onclick="document.getElementById('action').value='{{ action_id }}'">
                                        {{ action_label }}
                                    </button>
                                {% endif %}
                            {% endif %}

                            {% if action_id == 'resolve' %}
                                <div class="mb-3">
                                    <label for="resolution_notes" class="form-label">Resolution Notes</label>
                                    <textarea class="form-control" id="resolution_notes" name="resolution_notes" 
                                              rows="3" required></textarea>
                                </div>
                            {% endif %}
                        {% endfor %}


                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        Current Information
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Request Status -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted mb-0">Status</h6>
                            <span class="badge bg-{{ request.get_status_badge_color() }} px-3 py-2">
                                <i class="fas fa-circle me-1"></i>
                                {{ request.get_status_display() }}
                            </span>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-{{ request.get_status_badge_color() }}" style="width: {{ 
                                '100%' if request.status in ['resolved', 'closed'] 
                                else '75%' if request.status == 'visited'
                                else '50%' if request.status == 'scheduled'
                                else '25%' if request.status == 'assigned'
                                else '10%'
                            }}"></div>
                        </div>
                    </div>

                    <!-- Request Details -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">Request Details</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Title</span>
                                    <span class="text-break text-end" style="max-width: 60%;">{{ request.title }}</span>
                                </div>
                            </div>
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Priority</span>
                                    <span class="badge bg-{{ 
                                        'danger' if request.priority == 'urgent'
                                        else 'warning' if request.priority == 'high'
                                        else 'info' if request.priority == 'medium'
                                        else 'success'
                                    }} px-3">
                                        <i class="fas fa-{{ 
                                            'exclamation-triangle' if request.priority == 'urgent'
                                            else 'arrow-up' if request.priority == 'high'
                                            else 'arrow-right' if request.priority == 'medium'
                                            else 'arrow-down'
                                        }} me-1"></i>
                                        {{ request.priority|title }}
                                    </span>
                                </div>
                            </div>
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Equipment</span>
                                    <span class="text-end">
                                        {% if request.equipment_type %}
                                            <i class="fas fa-desktop me-1"></i> {{ request.equipment_type|title }}
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            {% if request.assigned_to %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Assigned To</span>
                                    <span>
                                        <i class="fas fa-user-tie me-1"></i>
                                        {{ request.assigned_to_user.full_name }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                            {% if request.scheduled_date and request.scheduled_time %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Scheduled Visit</span>
                                    <span>
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        {{ request.format_schedule_time() }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}

                            {% if request.visit_count > 0 %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Total Visits</span>
                                    <span>
                                        <i class="fas fa-clipboard-check me-1"></i>
                                        {{ request.visit_count }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}

                            {% if request.actual_visit_time %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Last Visit</span>
                                    <span>
                                        <i class="fas fa-history me-1"></i>
                                        {{ request.actual_visit_time.strftime('%Y-%m-%d %I:%M %p') }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Hold Reason -->
                    {% if request.on_hold_reason %}
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-pause-circle me-2"></i>Hold Reason
                        </h6>
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ request.on_hold_reason|nl2br }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Resolution Notes -->
                    {% if request.resolution_notes %}
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-check-circle me-2"></i>Resolution Notes
                        </h6>
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check me-2"></i>
                            {{ request.resolution_notes|nl2br }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Reopen Window -->
                    {% if request.status == 'RESOLVED' and request.reopen_deadline %}
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-redo me-2"></i>Reopen Window
                        </h6>
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Can be reopened until: {{ request.reopen_deadline.strftime('%Y-%m-%d %I:%M %p') }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# Hold Modal #}
<div class="modal fade" id="holdModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Put Request On Hold</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="hold_reason" class="form-label">Reason for Hold</label>
                        <textarea class="form-control" id="hold_reason" name="hold_reason" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="expected_resolution_date" class="form-label">Expected Resolution Date</label>
                        <input type="date" class="form-control" id="expected_resolution_date" 
                               name="expected_resolution_date" required min="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" onclick="document.getElementById('action').value='hold'">
                        Put on Hold
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Close Modal #}
<div class="modal fade" id="closeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Close Request with Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Note:</strong> If you close the request now, you won't be able to reopen it later.
                        Only close if you are fully satisfied with the resolution.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="rating">
                            {% for i in range(5, 0, -1) %}
                                <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                                <label for="star{{ i }}">☆</label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="feedback_comments" class="form-label">Comments (Optional)</label>
                        <textarea class="form-control" id="feedback_comments" name="feedback_comments" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" onclick="document.getElementById('action').value='close'">
                        Close Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Reopen Modal #}
<div class="modal fade" id="reopenModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reopen Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="comment" class="form-label">Reason for Reopening</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" onclick="document.getElementById('action').value='reopen'">
                        Reopen Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
.rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}

.rating input {
    display: none;
}

.rating label {
    cursor: pointer;
    font-size: 30px;
    color: #ddd;
    padding: 5px;
}

.rating input:checked ~ label {
    color: #ffd700;
}

.rating label:hover,
.rating label:hover ~ label {
    color: #ffd700;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Form elements
    const form = document.getElementById('serviceRequestForm');
    const problemCategory = document.getElementById('problem_category');
    const singleEquipmentFields = document.getElementById('single_equipment_fields');
    const networkFields = document.getElementById('network_fields');
    const issueTypeSelect = document.getElementById('issue_type');
    const prioritySelect = document.getElementById('priority');
    const priorityHelp = document.getElementById('priority-help');
    const progressBar = document.querySelector('.progress-bar');
    
    // Priority descriptions
    const priorityDescriptions = {
        'low': 'Minor issues that don\'t affect daily operations',
        'medium': 'Issues affecting some users or services',
        'high': 'Major issues affecting multiple users or critical services',
        'urgent': 'Critical issues requiring immediate attention'
    };
    
    // Hide all issue type groups initially
    function hideAllIssueTypes() {
        const optgroups = issueTypeSelect.getElementsByTagName('optgroup');
        for (let group of optgroups) {
            group.style.display = 'none';
        }
    }
    
    // Show specific issue type group
    function showIssueTypeGroup(className) {
        const group = issueTypeSelect.getElementsByClassName(className)[0];
        if (group) {
            group.style.display = '';
        }
    }
    
    // Update progress bar based on filled required fields
    function updateProgressBar() {
        const requiredFields = form.querySelectorAll('[required]');
        let filledCount = 0;
        
        requiredFields.forEach(field => {
            if (field.value) filledCount++;
        });
        
        const progress = (filledCount / requiredFields.length) * 100;
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
    }
    
    function updateVisibility() {
        // Hide all conditional fields first
        singleEquipmentFields.classList.add('d-none');
        networkFields.classList.add('d-none');
        hideAllIssueTypes();
        
        // Show relevant fields based on selection
        switch(problemCategory.value) {
            case 'single_equipment':
                singleEquipmentFields.classList.remove('d-none');
                break;
            case 'network':
                networkFields.classList.remove('d-none');
                showIssueTypeGroup('network-issues');
                break;
            case 'wifi':
                networkFields.classList.remove('d-none');
                showIssueTypeGroup('wifi-issues');
                break;
            case 'cctv':
                networkFields.classList.remove('d-none');
                showIssueTypeGroup('cctv-issues');
                break;
            case 'infrastructure':
                networkFields.classList.remove('d-none');
                showIssueTypeGroup('infrastructure-issues');
                break;
        }
        
        // Add icons to options
        const selectedOption = problemCategory.options[problemCategory.selectedIndex];
        const icon = selectedOption.getAttribute('data-icon');
        if (icon) {
            const label = document.querySelector(`label[for='${problemCategory.id}']`);
            label.innerHTML = `<i class="${icon} me-2"></i>${label.textContent}`;
        }
    }
    
    // Event Listeners
    form.addEventListener('input', updateProgressBar);
    problemCategory.addEventListener('change', updateVisibility);
    
    prioritySelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const badge = selectedOption.getAttribute('data-badge');
        const description = priorityDescriptions[this.value];
        
        if (badge && description) {
            priorityHelp.innerHTML = `<span class="badge bg-${badge} me-2">${selectedOption.text}</span>${description}`;
        } else {
            priorityHelp.innerHTML = '';
        }
    });
    
    // Add contract change listener to load equipment
    const contractSelect = document.getElementById('contract_id');
    const equipmentSelect = document.getElementById('equipment_id');
    
    contractSelect.addEventListener('change', function() {
        // Clear equipment select
        equipmentSelect.innerHTML = '<option value="">Select equipment</option>';
        
        if (this.value) {
            // Show loading state
            equipmentSelect.disabled = true;
            const loadingOption = new Option('Loading equipment...', '');
            equipmentSelect.add(loadingOption);
            
            // Fetch equipment for selected contract
            fetch(`/api/contract/${this.value}/equipment`)
                .then(response => response.json())
                .then(data => {
                    equipmentSelect.innerHTML = '<option value="">Select equipment</option>';
                    data.forEach(equipment => {
                        const option = document.createElement('option');
                        option.value = equipment.id;
                        option.textContent = `${equipment.name} (${equipment.type})`;
                        equipmentSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    equipmentSelect.innerHTML = '<option value="">Error loading equipment</option>';
                })
                .finally(() => {
                    equipmentSelect.disabled = false;
                });
        }
    });
    
    // Initialize form
    updateProgressBar();
    updateVisibility();
    
    // Set initial values for priority description and icons
    if (prioritySelect.value) {
        const selectedOption = prioritySelect.options[prioritySelect.selectedIndex];
        const badge = selectedOption.getAttribute('data-badge');
        const description = priorityDescriptions[prioritySelect.value];
        if (badge && description) {
            priorityHelp.innerHTML = `<span class="badge bg-${badge} me-2">${selectedOption.text}</span>${description}`;
        }
    }
});
</script>
{% endblock %}
