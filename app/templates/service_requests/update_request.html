{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1>Update Request #{{ request.ticket_number }}</h1>
    
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" id="action" value="">
                        
                        {% for action_id, action_label, action_color in request.get_allowed_actions(current_user) %}
                            {% if action_id == 'edit' %}
                                {# College Admin - Edit Request Form #}
                                <div class="mb-3">
                                    <h5>Edit Request Details</h5>
                                    <!-- Basic Info -->
                                    <div class="mb-3">
                                        <label for="title" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="title" name="title" 
                                               value="{{ request.title }}" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" id="description" name="description" 
                                                  rows="4" required>{{ request.description }}</textarea>
                                    </div>
                                    
                                    <!-- Problem Category Selection -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="problem_category" class="form-label">Problem Category</label>
                                            <select class="form-select" id="problem_category" name="problem_category" required>
                                                <option value="">Select category</option>
                                                <option value="single_equipment" {% if request.problem_category == 'single_equipment' %}selected{% endif %}>Single Equipment Issue</option>
                                                <option value="network" {% if request.problem_category == 'network' %}selected{% endif %}>Network Connectivity</option>
                                                <option value="wifi" {% if request.problem_category == 'wifi' %}selected{% endif %}>WiFi Coverage</option>
                                                <option value="cctv" {% if request.problem_category == 'cctv' %}selected{% endif %}>CCTV System</option>
                                                <option value="infrastructure" {% if request.problem_category == 'infrastructure' %}selected{% endif %}>Infrastructure</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="priority" class="form-label">Priority</label>
                                            <select class="form-select" id="priority" name="priority" required>
                                                <option value="">Select priority</option>
                                                <option value="low" {% if request.priority == 'low' %}selected{% endif %}>Low</option>
                                                <option value="medium" {% if request.priority == 'medium' %}selected{% endif %}>Medium</option>
                                                <option value="high" {% if request.priority == 'high' %}selected{% endif %}>High</option>
                                                <option value="urgent" {% if request.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                                            </select>
                                        </div>
                                    </div>
                                    </div>
                                    
                                    <!-- Single Equipment Fields -->
                                    <div id="single_equipment_fields" class="d-none">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="contract_id" class="form-label">AMC Contract</label>
                                                <select class="form-select" id="contract_id" name="contract_id">
                                                    <option value="">Select contract</option>
                                                    {% for contract in contracts %}
                                                    <option value="{{ contract.id }}" {% if request.contract_id == contract.id %}selected{% endif %}>
                                                        {{ contract.contract_number }} ({{ contract.contract_type }})
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="equipment_id" class="form-label">Equipment</label>
                                                <select class="form-select" id="equipment_id" name="equipment_id">
                                                    <option value="">Select equipment</option>
                                                    {% if request.equipment %}
                                                    <option value="{{ request.equipment.id }}" selected>
                                                        {{ request.equipment.name }} ({{ request.equipment.type }})
                                                    </option>
                                                    {% endif %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Network/WiFi Fields -->
                                    <div id="network_fields" class="d-none">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="issue_type" class="form-label">Issue Type</label>
                                                <select class="form-select" id="issue_type" name="issue_type">
                                                    <option value="">Select issue type</option>
                                                    <!-- Network Issues -->
                                                    <optgroup label="Network Issues" class="network-issues">
                                                        <option value="no_internet" {% if request.issue_type == 'no_internet' %}selected{% endif %}>No Internet Connection</option>
                                                        <option value="slow_speed" {% if request.issue_type == 'slow_speed' %}selected{% endif %}>Slow Network Speed</option>
                                                        <option value="intermittent" {% if request.issue_type == 'intermittent' %}selected{% endif %}>Intermittent Connection</option>
                                                        <option value="dns_issue" {% if request.issue_type == 'dns_issue' %}selected{% endif %}>DNS Resolution Problem</option>
                                                    </optgroup>
                                                    <!-- WiFi Issues -->
                                                    <optgroup label="WiFi Issues" class="wifi-issues">
                                                        <option value="no_wifi" {% if request.issue_type == 'no_wifi' %}selected{% endif %}>No WiFi Signal</option>
                                                        <option value="weak_signal" {% if request.issue_type == 'weak_signal' %}selected{% endif %}>Weak WiFi Signal</option>
                                                        <option value="authentication" {% if request.issue_type == 'authentication' %}selected{% endif %}>WiFi Authentication Error</option>
                                                        <option value="frequent_disconnect" {% if request.issue_type == 'frequent_disconnect' %}selected{% endif %}>Frequent Disconnection</option>
                                                    </optgroup>
                                                    <!-- CCTV Issues -->
                                                    <optgroup label="CCTV Issues" class="cctv-issues">
                                                        <option value="no_feed" {% if request.issue_type == 'no_feed' %}selected{% endif %}>No Camera Feed</option>
                                                        <option value="poor_quality" {% if request.issue_type == 'poor_quality' %}selected{% endif %}>Poor Video Quality</option>
                                                        <option value="recording_issue" {% if request.issue_type == 'recording_issue' %}selected{% endif %}>Recording Not Working</option>
                                                        <option value="playback_issue" {% if request.issue_type == 'playback_issue' %}selected{% endif %}>Playback Problems</option>
                                                    </optgroup>
                                                    <!-- Infrastructure Issues -->
                                                    <optgroup label="Infrastructure Issues" class="infrastructure-issues">
                                                        <option value="cable_damage" {% if request.issue_type == 'cable_damage' %}selected{% endif %}>Cable/Wire Damage</option>
                                                        <option value="port_issue" {% if request.issue_type == 'port_issue' %}selected{% endif %}>Network Port Problem</option>
                                                        <option value="ups_issue" {% if request.issue_type == 'ups_issue' %}selected{% endif %}>UPS/Power Issue</option>
                                                        <option value="rack_issue" {% if request.issue_type == 'rack_issue' %}selected{% endif %}>Network Rack Problem</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="affected_users" class="form-label">Affected Users</label>
                                                <input type="number" class="form-control" id="affected_users" name="affected_users"
                                                       value="{{ request.affected_users }}" placeholder="Number of users affected">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Location Fields -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="building" class="form-label">Building</label>
                                            <input type="text" class="form-control" id="building" name="building"
                                                   value="{{ request.building }}" placeholder="Building name/number">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="floor" class="form-label">Floor</label>
                                            <input type="text" class="form-control" id="floor" name="floor"
                                                   value="{{ request.floor }}" placeholder="Floor number">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="room" class="form-label">Room/Lab</label>
                                            <input type="text" class="form-control" id="room" name="room"
                                                   value="{{ request.room }}" placeholder="Room/Lab number">
                                        </div>
                                    </div>
                                    
                                    <!-- Additional Details -->
                                    <div class="mb-3">
                                        <label for="area_details" class="form-label">Additional Location Details</label>
                                        <textarea class="form-control" id="area_details" name="area_details" rows="2"
                                                  placeholder="Any additional details about the location">{{ request.area_details }}</textarea>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-{{ action_color }}" 
                                        onclick="document.getElementById('action').value='{{ action_id }}'">
                                    {{ action_label }}
                                </button>
                            {% elif action_id in ['schedule', 'reschedule'] %}
                                {# Junior Technician - Schedule Visit Form #}
                                <div class="mb-3">
                                    <h5>Schedule Visit</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="scheduled_date" class="form-label">Date</label>
                                            <input type="date" class="form-control" id="scheduled_date" 
                                                   name="scheduled_date" required min="{{ now.strftime('%Y-%m-%d') }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="scheduled_time" class="form-label">Time</label>
                                            <input type="time" class="form-control" id="scheduled_time" 
                                                   name="scheduled_time" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="comment" class="form-label">Add Comment</label>
                                    <textarea class="form-control" id="comment" name="comment" rows="3" 
                                              placeholder="Add details about the scheduled visit"></textarea>
                                </div>
                                <button type="submit" class="btn btn-{{ action_color }}" 
                                        onclick="document.getElementById('action').value='{{ action_id }}'">
                                    {{ action_label }}
                                </button>
                            {% elif action_id == 'mark_visited' %}
                                {# College Admin - Mark Visit Form #}
                                <div class="mb-3">
                                    <h5>Confirm Technician Visit</h5>
                                    <p class="text-muted">Scheduled for: {{ request.format_schedule_time() }}</p>
                                    <div class="mb-3">
                                        <label for="comment" class="form-label">Visit Notes</label>
                                        <textarea class="form-control" id="comment" name="comment" rows="3" required
                                                  placeholder="Please provide details about the technician's visit and work done"></textarea>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-{{ action_color }}" 
                                        onclick="document.getElementById('action').value='{{ action_id }}'">
                                    {{ action_label }}
                                </button>
                            {% else %}
                                {% if action_id in ['hold', 'close', 'reopen'] %}
                                    <button type="button" class="btn btn-{{ action_color }} mb-3" 
                                            data-bs-toggle="modal" data-bs-target="#{{ action_id }}Modal">
                                        {{ action_label }}
                                    </button>
                                {% else %}
                                    <button type="submit" class="btn btn-{{ action_color }} mb-3" 
                                            onclick="document.getElementById('action').value='{{ action_id }}'">
                                        {{ action_label }}
                                    </button>
                                {% endif %}
                            {% endif %}

                            {% if action_id == 'resolve' %}
                                <div class="mb-3">
                                    <label for="resolution_notes" class="form-label">Resolution Notes</label>
                                    <textarea class="form-control" id="resolution_notes" name="resolution_notes" 
                                              rows="3" required></textarea>
                                </div>
                            {% endif %}
                        {% endfor %}


                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Current Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Title</dt>
                        <dd class="col-sm-8">{{ request.title }}</dd>

                        <dt class="col-sm-4">Status</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-{{ request.get_status_badge_color() }}">
                                {{ request.get_status_display() }}
                            </span>
                        </dd>

                        <dt class="col-sm-4">Priority</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-{{ 
                                'danger' if request.priority == 'urgent'
                                else 'warning' if request.priority == 'high'
                                else 'info' if request.priority == 'medium'
                                else 'secondary'
                            }}">
                                {{ request.priority|title }}
                            </span>
                        </dd>

                        <dt class="col-sm-4">Equipment</dt>
                        <dd class="col-sm-8">{{ request.equipment_type|title }}</dd>

                        {% if request.assigned_to %}
                            <dt class="col-sm-4">Assigned To</dt>
                            <dd class="col-sm-8">{{ request.assigned_to_user.full_name }}</dd>
                        {% endif %}

                        {% if request.scheduled_date and request.scheduled_time %}
                            <dt class="col-sm-4">Scheduled Visit</dt>
                            <dd class="col-sm-8">{{ request.format_schedule_time() }}</dd>
                        {% endif %}

                        {% if request.visit_count > 0 %}
                            <dt class="col-sm-4">Visits</dt>
                            <dd class="col-sm-8">{{ request.visit_count }}</dd>
                        {% endif %}

                        {% if request.actual_visit_time %}
                            <dt class="col-sm-4">Last Visit</dt>
                            <dd class="col-sm-8">{{ request.actual_visit_time.strftime('%Y-%m-%d %I:%M %p') }}</dd>
                        {% endif %}

                        {% if request.on_hold_reason %}
                            <dt class="col-sm-12 mt-3">Hold Reason</dt>
                            <dd class="col-sm-12">
                                <div class="alert alert-warning mb-0">
                                    {{ request.on_hold_reason|nl2br }}
                                </div>
                            </dd>
                        {% endif %}

                        {% if request.resolution_notes %}
                            <dt class="col-sm-12 mt-3">Resolution Notes</dt>
                            <dd class="col-sm-12">
                                <div class="alert alert-success mb-0">
                                    {{ request.resolution_notes|nl2br }}
                                </div>
                            </dd>
                        {% endif %}

                        {% if request.status == 'RESOLVED' and request.reopen_deadline %}
                            <dt class="col-sm-12 mt-3">Reopen Window</dt>
                            <dd class="col-sm-12">
                                <div class="alert alert-info mb-0">
                                    Can be reopened until: {{ request.reopen_deadline.strftime('%Y-%m-%d %I:%M %p') }}
                                </div>
                            </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

{# Hold Modal #}
<div class="modal fade" id="holdModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Put Request On Hold</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="hold_reason" class="form-label">Reason for Hold</label>
                        <textarea class="form-control" id="hold_reason" name="hold_reason" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="expected_resolution_date" class="form-label">Expected Resolution Date</label>
                        <input type="date" class="form-control" id="expected_resolution_date" 
                               name="expected_resolution_date" required min="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" onclick="document.getElementById('action').value='hold'">
                        Put on Hold
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Close Modal #}
<div class="modal fade" id="closeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Close Request with Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Note:</strong> If you close the request now, you won't be able to reopen it later.
                        Only close if you are fully satisfied with the resolution.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="rating">
                            {% for i in range(5, 0, -1) %}
                                <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                                <label for="star{{ i }}">â˜†</label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="feedback_comments" class="form-label">Comments (Optional)</label>
                        <textarea class="form-control" id="feedback_comments" name="feedback_comments" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" onclick="document.getElementById('action').value='close'">
                        Close Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Reopen Modal #}
<div class="modal fade" id="reopenModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reopen Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="comment" class="form-label">Reason for Reopening</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" onclick="document.getElementById('action').value='reopen'">
                        Reopen Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
.rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}

.rating input {
    display: none;
}

.rating label {
    cursor: pointer;
    font-size: 30px;
    color: #ddd;
    padding: 5px;
}

.rating input:checked ~ label {
    color: #ffd700;
}

.rating label:hover,
.rating label:hover ~ label {
    color: #ffd700;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const problemCategory = document.getElementById('problem_category');
    const singleEquipmentFields = document.getElementById('single_equipment_fields');
    const networkFields = document.getElementById('network_fields');
    const issueTypeSelect = document.getElementById('issue_type');
    
    // Hide all issue type groups initially
    function hideAllIssueTypes() {
        const optgroups = issueTypeSelect.getElementsByTagName('optgroup');
        for (let group of optgroups) {
            group.style.display = 'none';
        }
    }
    
    // Show specific issue type group
    function showIssueTypeGroup(className) {
        const group = issueTypeSelect.getElementsByClassName(className)[0];
        if (group) {
            group.style.display = '';
        }
    }
    
    function updateVisibility() {
        // Hide all conditional fields first
        singleEquipmentFields.classList.add('d-none');
        networkFields.classList.add('d-none');
        hideAllIssueTypes();
        
        // Show relevant fields based on selection
        switch(problemCategory.value) {
            case 'single_equipment':
                singleEquipmentFields.classList.remove('d-none');
                break;
            case 'network':
                networkFields.classList.remove('d-none');
                showIssueTypeGroup('network-issues');
                break;
            case 'wifi':
                networkFields.classList.remove('d-none');
                showIssueTypeGroup('wifi-issues');
                break;
            case 'cctv':
                networkFields.classList.remove('d-none');
                showIssueTypeGroup('cctv-issues');
                break;
            case 'infrastructure':
                networkFields.classList.remove('d-none');
                showIssueTypeGroup('infrastructure-issues');
                break;
        }
    }
    
    problemCategory.addEventListener('change', updateVisibility);
    
    // Add contract change listener to load equipment
    const contractSelect = document.getElementById('contract_id');
    const equipmentSelect = document.getElementById('equipment_id');
    
    contractSelect.addEventListener('change', function() {
        // Clear equipment select
        equipmentSelect.innerHTML = '<option value="">Select equipment</option>';
        
        if (this.value) {
            // Fetch equipment for selected contract
            fetch(`/api/contract/${this.value}/equipment`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(equipment => {
                        const option = document.createElement('option');
                        option.value = equipment.id;
                        option.textContent = `${equipment.name} (${equipment.type})`;
                        equipmentSelect.appendChild(option);
                    });
                });
        }
    });
    
    // Show correct fields on page load
    updateVisibility();
});
</script>
{% endblock %}
